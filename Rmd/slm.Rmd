---
title: "Linear Regression"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
library("ggplot2")
library("plotly")
library("gridExtra")
library("rmarkdown")
library("knitr")
library("pander")
library("shinythemes")

knitr::opts_chunk$set(echo = TRUE)
```
This Shiny App performs a simple and multiple linear regression. The user can upload (or input) the dataset of interest. User will obtain estimates of the parameters in the model. Also confidence intervals (CI), the default is 95% CI, as well $p$-value. We can check for the assumptions of normality based on the quantile-quantile plot, assumption of constant variance and linearity.

### Simple Linear regression

Obtain a fitted model of the simple linear regression:
\[
Y_i = \beta_0+\beta_1 x_i+\varepsilon_i
\]
where $Y_i \sim N(\beta_0+\beta_1 x_i,\sigma^2)$ and $\varepsilon_i \sim N(0,\sigma^2)$.
To learn more, see [Interactive Documents](http://rmarkdown.rstudio.com/authoring_shiny.html).



```{r interface-slm, echo=FALSE}

    sidebarLayout(
                  sidebarPanel(
                    tags$b("Data:"),
                    textInput("x", "x", value = "90, 100, 90, 80, 87, 75", placeholder = "Enter values separated by a comma, e.g. 1, 2, 3, etc."),
                    textInput("y", "y", value = "950, 1100, 850, 750, 950, 775", placeholder = "Enter values separated by a comma, e.g. 4,5,6, etc."),
                    textInput("alpha","alpha",value="0.05",placeholder="Significance level"),
                    hr(),
                    tags$b("Plot:"),
                    textInput("xlab", label = "Axis labels:", value = "x", placeholder = "x label"),
                    textInput("ylab", label = NULL, value = "y", placeholder = "y label"),
                    checkboxInput("se", "Add confidence interval around the regression line", TRUE)
                    ),
                  mainPanel(
                    
                    tabsetPanel(type = "tabs",
                                tabPanel("Data", DT::dataTableOutput('tbl')), # Data as datatable
                                tabPanel("Summary",
                                         br(),
                                         tags$b("Sample means of variables"),
                                         uiOutput("data"),
                                         br(),
                                         tags$b("Estimates of the slope and intercept"),
                                         uiOutput("parameters"),
                                         br(),
                                         tags$b("Table Output"),
                                         uiOutput("tableoutput")),
                                tabPanel("Regression plot", plotlyOutput("plot")), # Plot
                                tabPanel("Residuals",
                                         br(),
                                         tags$b("Fitted values vs Residuals"),
                                         plotlyOutput("diagnostic1"),
                                         br(),
                                         tags$b("QQ-Plot"),
                                         plotlyOutput("diagnostic3"),
                                         br(),
                                         tags$b("Fitted values vs Studentized Residuals"),
                                         plotlyOutput("diagnostic2"),
                                         br(),
                                         tags$b("QQ-Plot (Studentized Residuals)"),
                                         plotlyOutput("diagnostic4"),
                                         br(),
                                ),
                                tabPanel("Interpretation", uiOutput("interpretation")),
                                tabPanel("R output", verbatimTextOutput("summary")))# Regression output
                    
                  )
                )
##
  extract <- function(text) {
    text <- gsub(" ", "", text)
    split <- strsplit(text, ",", fixed = FALSE)[[1]]
    as.numeric(split)
  }
  
  ## Data output
  output$tbl <- DT::renderDataTable({
    y <- extract(input$y)
    x <- extract(input$x)
    DT::datatable(data.frame(x, y))
  })
  
  output$data <- renderUI({
    y <- extract(input$y)
    x <- extract(input$x)
    if (anyNA(x) | length(x) < 2 | anyNA(y) | length(y) < 2) {
      "Invalid input or not enough observations"
    } else if (length(x) != length(y)) {
      "Number of observations must be equal for x and y"
    } else {
      withMathJax(
        paste0("$\\bar{x} =$ ", round(mean(x), 3)),
        br(),
        paste0("$\\bar{y} =$ ", round(mean(y), 3)),
        br(),
        paste0("$n =$ ", length(x))
      )
    }
  })
  
  output$parameters <- renderUI({
    y <- extract(input$y)
    x <- extract(input$x)
    if (anyNA(x) | length(x) < 2 | anyNA(y) | length(y) < 2) {
      "Invalid input or not enough observations"
    } else if (length(x) != length(y)) {
      "Number of observations must be equal for x and y"
    } else {
      fit <- lm(y ~ x)
      b0 <- round(fit$coef[["(Intercept)"]], 3)
      b1 <- round(fit$coef[["x"]], 3)
      pv <- round(summary(fit)$coef["x","Pr(>|t|)"],digits=3)
      r2 <- round(summary(fit)$adj.r.squared, digits=3)
      if(b1 > 0){
        withMathJax(
          paste0("$ \\hat{\\beta}_0 = $ ", b0),#,", ", ci.b0),
          br(),
          paste0("$ \\hat{\\beta}_1 = $  ", b1),#,", ",ci.b1),
          br(),
          paste0("Fitted model: $ \\hat{y} = $ ", b0, " + ", b1, "$ x $")
        )
      } 
      else{
        withMathJax(
          paste0("$ \\hat{\\beta}_0 = $ ", b0),
          br(),
          paste0("$ \\hat{\\beta}_1 = $  ", b1),
          br(),
          paste0("Fitted model: $ \\hat{y} = $ ", b0, b1, "$ x $")
        ) 
      }
    }
    
  })
  
  output$tableoutput <- renderTable({
    y <- extract(input$y)
    x <- extract(input$x)
    alpha <- as.numeric(input$alpha)
    fit <- lm(y ~ x)
    bb <- summary(fit)$coefficients
    d <- cbind(bb,confint(fit,level=1-alpha))
    rownames(d) <- c("Intercept","Slope")
    d
  },rownames = TRUE)
  output$summary <- renderPrint({
    y <- extract(input$y)
    x <- extract(input$x)
    fit <- lm(y ~ x)
    summary(fit)
  })
  
  
  output$diagnostic1 <- renderPlotly({
    y <- extract(input$y)
    x <- extract(input$x)
    fit <- lm(y ~ x)
    dat <- data.frame(yhat = fitted(fit), r = residuals(fit))
    p <- ggplot(dat, aes(x = yhat, y = r)) +
      geom_point(size=2) +
      geom_hline(yintercept = 0)+
      ylab("Residuals") +
      xlab("Fitted values") +
      theme_bw()
    ggplotly(p)
    
  })
  
  output$diagnostic2 <- renderPlotly({
    y <- extract(input$y)
    x <- extract(input$x)
    fit <- lm(y ~ x)
    dat <- data.frame(yhat = fitted(fit), r = residuals(fit))
    ## studentized residuals
    dat2 <- data.frame(yhat = fitted(fit), r = MASS::studres(fit))
    p1 <- ggplot(dat2, aes(x = yhat, y = r)) +
      geom_point(size=2) +
      geom_hline(yintercept = 0)+
      ylab("Studentized Residuals") +
      xlab("Fitted values") +
      theme_bw()
    ggplotly(p1)
    
  })
  
  output$diagnostic3 <- renderPlotly({
    y <- extract(input$y)
    x <- extract(input$x)
    fit <- lm(y ~ x)
    dat <- data.frame( y = residuals(fit))
    p <- ggplot(dat, aes(sample = y)) +
      stat_qq() + stat_qq_line()+ theme_bw()
    ggplotly(p)
    
  })
  
  output$diagnostic4 <- renderPlotly({
    y <- extract(input$y)
    x <- extract(input$x)
    fit <- lm(y ~ x)
    dat <- data.frame( y = MASS::stdres(fit))
    p <- ggplot(dat, aes(sample = y)) +
      stat_qq() + stat_qq_line()+ theme_bw()
    ggplotly(p)
    
  })
  
  output$interpretation <- renderUI({
    y <- extract(input$y)
    x <- extract(input$x)
    fit <- lm(y ~ x)
    alpha <- input$alpha
    b0 <- round(fit$coef[["(Intercept)"]], digits=3)
    b1 <- round(fit$coef[["x"]], digits= 3)
    pv0 <- round(summary(fit)$coef["(Intercept)","Pr(>|t|)"],digits=3)
    pv1 <- round(summary(fit)$coef["x","Pr(>|t|)"],digits=3)
    if ((pv0 < alpha) & (pv1 < alpha)) {
      withMathJax(
        paste0("(Make sure the assumptions for linear regression (independence, linearity, normality and homoscedasticity) are met before interpreting the coefficients.)"),
        br(),
        paste0("For a (hypothetical) value of ", input$xlab, " = 0, the mean of ", input$ylab, " = ", b0, "."),
        br(),
        paste0("For an increase of one unit of ", input$xlab, ", ", input$ylab, ifelse(b1 >= 0, " increases (on average) by ", " decreases (on average) by "), abs(b1), ifelse(abs(b1) >= 2, " units", " unit"), ".")
      )
    } else if ((pv0 < alpha) & (pv1 >= alpha)) {
      withMathJax(
        paste0("(Make sure the assumptions for linear regression (independence, linearity, normality and homoscedasticity) are met before interpreting the coefficients.)"),
        br(),
        paste0("For a (hypothetical) value of ", input$xlab, " = 0, the mean of ", input$ylab, " = ", b1, "."),
        br(),
        paste0("$ \\beta_1 $", " is not significantly different from 0 ($p$-value = ", pv1, ") so there is no significant relationship between ", input$xlab, " and ", input$ylab, ".")
      )
    } else if ((pv0 >= alpha) & (pv1 < alpha)) {
      withMathJax(
        paste0("(Make sure the assumptions for linear regression (independence, linearity, normality and homoscedasticity) are met before interpreting the coefficients.)"),
        br(),
        paste0("$ \\beta_0 $", " is not significantly different from 0 ($p$-value = ", pv0, ") so when ", input$xlab, " = 0, the mean of ", input$ylab, " is not significantly different from 0."),
        br(),
        paste0("For an increase of one unit of ", input$xlab, ", ", input$ylab, ifelse(b1 >= 0, " increases (on average) by ", " decreases (on average) by "), abs(b1), ifelse(abs(b1) >= 2, " units", " unit"), ".")
      )
    } else {
      withMathJax(
        paste0("(Make sure the assumptions for linear regression (independence, linearity, normality and homoscedasticity) are met before interpreting the coefficients.)"),
        br(),
        paste0("$\\beta_0 $", " and ", "$ \\beta_1 $", " are not significantly different from 0 (p-values = ",pv0 , " and ", pv1, ", respectively) so the mean of ", input$ylab, " is not significantly different from 0.")
      )
    }
  })
  
  output$plot <- renderPlotly({
    y <- extract(input$y)
    x <- extract(input$x)
    fit <- lm(y ~ x)
    dat <- data.frame(x, y)
    p <- ggplot(dat, aes(x = x, y = y)) +
      geom_point() +
      stat_smooth(method = "lm", se = input$se) +
      ylab(input$ylab) +
      xlab(input$xlab) +
      theme_minimal()
    ggplotly(p)
  })
  


```



